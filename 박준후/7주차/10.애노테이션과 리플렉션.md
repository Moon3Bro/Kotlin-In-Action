# 10. μ• λ…Έν…μ΄μ…κ³Ό λ¦¬ν”λ™μ…

ν΄λμ¤μ™€ ν•¨μλ¥Ό μ‚¬μ©ν•λ” μ—¬λ¬ μ½”ν‹€λ¦° νΉμ„±λ“¤μ€ λ¨λ‘ `ν•¨μ` λ‚ `ν΄λμ¤` μ΄λ¦„μ„ μ†μ¤μ½”λ“μ—μ„ μ •ν™•ν•κ² μ•κ³  μμ–΄μ•Όλ§ μ‚¬μ©ν•  μ μλ” κΈ°λ¥μ΄μ€λ‹¤.

μ• λ…Έν…μ΄μ…κ³Ό λ¦¬ν”λ ‰μ…μ„ μ‚¬μ©ν•λ©΄ κ·Έλ° μ μ•½μ„ λ²—μ–΄λ‚μ„ λ―Έλ¦¬ μ•μ§€ λ»ν•λ” μ„μμ ν΄λμ¤λ¥Ό λ‹¤λ£° μ μλ‹¤.

## π“Β μ• λ…Έν…μ΄μ… μ„ μ–Έκ³Ό μ μ©

- μλ°”μ™€ λ§μΉκ°€μ§€λ΅ μ½”ν‹€λ¦° μ• λ…Έν…μ΄μ…λ„ κ°λ…μ€ κ°™λ‹¤. λ©”νƒ€λ°μ΄ν„°λ¥Ό μ„ μ–Έμ— μ¶”κ°€ν•λ©΄ μ• λ…Έν…μ΄μ…μ„ μ²λ¦¬ν•λ” λ„κµ¬κ°€ μ»΄νμΌ μ‹μ μ΄λ‚ λ°νƒ€μ„ μ‹μ μ— μ μ ν• μ²λ¦¬λ¥Ό ν•΄μ¤€λ‹¤.

### μ• λ…Έν…μ΄μ… μ μ©

- μ½”ν‹€λ¦°μ—μ„λ” μλ°”μ™€ κ°™μ€ λ°©λ²•μΌλ΅ μ• λ…Έν…μ΄μ…μ„ μ‚¬μ©ν•  μ μλ‹¤.
- μ• λ…Έν…μ΄μ…μ€ `@`  κ³Ό μ• λ…Έν…μ΄μ… μ΄λ¦„μΌλ΅ μ΄λ¤„μ§„λ‹¤.
- μ½”ν‹€λ¦°μ @Deprecated μ• λ…Έν…μ΄μ…μ—μ„λ” replaceWith νλΌλ―Έν„°λ¥Ό ν†µν•΄ μ›λ²„μ „μ„ λ€μ‹ ν•  μ μλ” ν¨ν„΄μ„ μ μ‹ν•  μ μκ³ , API μ‚¬μ©μλ” κ·Έ ν¨ν„΄μ„ λ³΄κ³  μ§€μ›μ΄ μΆ…λ£λ  API κΈ°λ¥μ„ λ” μ‰½κ² μƒ λ²„μ „μΌλ΅ ν¬ν…ν•  μ μλ‹¤.

```kotlin
@Deprecated("Use removeAt(index) instead.", ReplaceWith("removeAt(index"))
fun remove(index: Int) {}
```

- μ΄λ° remove ν•¨μ μ„ μ–Έμ΄ μλ‹¤λ©΄ κ²½κ³  λ©”μ‹μ§€μ™€ μƒλ΅μ΄ API λ²„μ „μ— λ§λ” μ½”λ“λ΅ λ°”κΏ”μ£Όλ” ν€µ ν”½μ¤λ„ μ μ‹ν•΄μ¤€λ‹¤.
- μ• λ…Έν…μ΄μ…μ μΈμλ΅λ” μ›μ‹ νƒ€μ…μ κ°’, λ¬Έμμ—΄, enum, ν΄λμ¤ μ°Έμ΅°, λ‹¤λ¥Έ μ• λ…Έν…μ΄μ… ν΄λμ¤, κ·Έλ¦¬κ³  μ§€κΈκΉμ§€ λ§ν• μ”μ†λ“¤λ΅ μ΄λ£¨μ–΄μ§„ λ°°μ—΄μ΄ λ“¤μ–΄κ° μ μλ‹¤.
- μ½”ν‹€λ¦°μ—μ„μ μ• λ…Έν…μ΄μ… μΈμλ¥Ό μ§€μ •ν•λ” λ¬Έλ²•
    - ν΄λμ¤λ¥Ό μ• λ…Έν…μ΄μ… μΈμλ΅ μ§€μ •ν•  λ•λ” @MyAnnotation(MyClass::class) μ²λΌ ::classλ¥Ό ν΄λμ¤ μ΄λ¦„ λ’¤μ— λ„£μ–΄μ•Ό ν•λ‹¤.
    - λ‹¤λ¥Έ μ• λ…Έν…μ΄μ…μ„ μΈμλ΅ μ§€μ •ν•  λ•λ” μΈμλ΅ λ“¤μ–΄κ°€λ” μ• λ…Έν…μ΄μ…μ μ΄λ¦„ μ•μ— @λ¥Ό λ„£μ§€ μ•μ•„μ•Ό ν•λ‹¤. (ex ReplaceWithμ—λ” @λ¥Ό λ„£μ§€ μ•μ)
    - λ°°μ—΄μ„ μΈμλ΅ μ΄μ •ν•λ ¤λ©΄ @RequestMapping(path = arrayOf(β€/fooβ€, β€/barβ€)) μ²λΌ arrayOf ν•¨μλ¥Ό μ‚¬μ©ν•λ‹¤. μλ°”μ—μ„ μ„ μ–Έν• μ• λ…Έν…μ΄μ… ν΄λμ¤λ¥Ό μ‚¬μ©ν•λ‹¤λ©΄ valueλΌλ” μ΄λ¦„μ νλΌλ―Έν„°κ°€ ν•„μ”μ— λ”°λΌ μλ™μΌλ΅ κ°€λ³€ κΈΈμ΄ μΈμλ΅ λ³€ν™λλ‹¤. λ”°λΌμ„ κ·Έλ° κ²½μ°μ—λ” @JavaAnnotationWithArrayValue(β€abcβ€, β€fooβ€, β€barβ€) μ²λΌ arrayOf ν•¨μλ¥Ό μ“°μ§€ μ•μ•„λ„ λλ‹¤.
- μ• λ…Έν…μ΄μ… μΈμλ¥Ό μ»΄νμΌ μ‹μ μ— μ• μ μμ–΄μ•Ό ν•κΈ° λ•λ¬Έμ— μ„μμ ν”„λ΅νΌν‹°λ¥Ό μΈμλ΅ μ§€μ •ν•  μ μ—†λ‹¤.
    - `const` λ³€κ²½μλ¥Ό λ¶™μ—¬μ„ μ»΄νμΌ μ‹μ μ— μƒμλ΅ μ·¨κΈ‰κ°€λ¥ν•κ² ν•μ—¬ μ‚¬μ©ν•΄μ•Ό ν•λ‹¤.

### μ• λ…Έν…μ΄μ… λ€μƒ

- μ½”ν‹€λ¦° μ†μ¤μ½”λ“μ—μ„ ν• μ„ μ–Έμ„ μ»΄νμΌν• κ²°κ³Όκ°€ μ—¬λ¬ μλ°” μ„ μ–Έκ³Ό λ€μ‘ν•λ” κ²½μ°κ°€ μμ£Ό μλ‹¤.
- μλ¥Ό λ“¤μ–΄ μ½”ν‹€λ¦° ν”„λ΅νΌν‹°λ” κΈ°λ³Έμ μΌλ΅ μλ°” ν•„λ“μ™€ κ²ν„° λ©”μ†λ“ μ„ μ–Έκ³Ό λ€μ‘ν•λ‹¤. ν”„λ΅νΌν‹°κ°€ λ³€κ²½ κ°€λ¥ν•λ©΄ μ„Έν„°μ— λ€μ‘ν•λ” μλ°” μ„Έν„° λ©”μ†λ“μ™€ μ„Έν„° νλΌλ―Έν„°κ°€ μ¶”κ°€λλ‹¤. κ²λ‹¤κ°€ μ£Ό μƒμ„±μμ—μ„ ν”„λ΅νΌν‹°λ¥Ό μ„ μ–Έν•λ©΄ μ΄λ° μ ‘κ·Όμ λ©”μ†λ“μ™€ νλΌλ―Έν„° μ™Έμ— μλ°” μƒμ„±μ νλΌλ―Έν„°μ™€λ„ λ€μ‘μ΄ λλ‹¤. λ”°λΌμ„ μ• λ…Έν…μ΄μ…μ„ λ¶™μΌ λ• μ΄λ° μ”μ† μ¤‘ μ–΄λ–¤ μ”μ†μ— μ• λ…Έν…μ΄μ…μ„ λ¶™μΌμ§€ ν‘μ‹ν•  ν•„μ”κ°€ μλ‹¤.
- **μ‚¬μ© μ €μ  λ€μ‘** μ„ μ–ΈμΌλ΅ μ• λ…Έν…μ΄μ…μ„ λ¶™μΌ μ”μ†λ¥Ό μ§€μ •ν•  μ μλ‹¤. μ§€μ  λ€μƒμ€ @ κΈ°νΈμ™€ μ• λ…Έν…μ΄μ… μ΄λ¦„ μ‚¬μ΄μ— λ¶™μΌλ©°, μ•¤γ…—ν…μ΄μ… μ΄λ¦„κ³Όλ” μ½λ΅ (:)μΌλ΅ λ¶„λ¦¬λλ‹¤.

```kotlin
        @get:Rule
μ‚¬μ© μ§€μ  λ€μƒ | μ• λ…Έν…μ΄μ… μ΄λ¦„
```

- μλ°”μ— μ„ μ–Έλ μ• λ…Έν…μ΄μ…μ„ μ‚¬μ©ν•΄ ν”„λ΅νΌν‹°μ— μ• λ…Έν…μ΄μ…μ„ λ¶™μ΄λ” κ²½μ° κΈ°λ³Έμ μΌλ΅ ν”„λ΅νΌν‹°μ ν•„λ“μ— κ·Έ μ• λ…Έν…μ΄μ…μ΄ λ¶™λ”λ‹¤.
- ν•μ§€λ§ μ½”ν‹€λ¦°μΌλ΅ μ• λ…Έν…μ΄μ…μ„ μ„ μ–Έν•λ©΄ ν”„λ΅νΌν‹°μ— μ§μ ‘ μ μ©ν•  μ μλ” μ• λ…Έν…μ΄μ…μ„ λ§λ“¤ μ μλ‹¤.
- μ‚¬μ© μ§€μ  λ€μƒμ„ μ§€μ •ν•  λ• μ§€μ›ν•λ” λ©λ΅
    - `property`: ν”„λ΅νΌν‹° μ „μ²΄. μλ°”μ—μ„ μ„ μ–Έλ μ• λ…Έν…μ΄μ…μ—λ” μ΄ μ‚¬μ© μ§€μ  λ€μƒμ„ μ‚¬μ©ν•  μ μ—†λ‹¤
    - `field` : ν”„λ΅νΌν‹°μ— μν•΄ μƒμ„±λλ” ν•„λ“
    - `get` : ν”„λ΅νΌν‹° κ²ν„°
    - `set` : ν”„λ΅νΌν‹° μ„Έν„°
    - `receiver` : ν™•μ¥ ν•¨μλ‚ ν”„λ΅νΌν‹°μ μμ‹  κ°μ²΄ νλΌλ―Έν„°
    - `param` : μƒμ„±μ νλΌλ―Έν„°
    - `setparam` : μ„Έν„° νλΌλ―Έν„°
    - `delegate` : μ„μ„ ν”„λ΅νΌν‹°μ μ„μ„ μΈμ¤ν„΄μ¤λ¥Ό λ‹΄μ•„λ‘” ν•„λ“
    - `file` : νμΌ μ•μ— μ„ μ–Έλ μµμƒμ„ ν•¨μμ™€ ν”„λ΅νΌν‹°λ¥Ό λ‹΄μ•„λ‘λ” ν΄λμ¤

```kotlin
file λ€μƒμ„ μ‚¬μ©ν•λ” μ• λ…Έν…μ΄μ…μ€ package μ„ μ–Έ μ•μ—μ„ νμΌμ μµμƒμ„ μμ¤€μ—λ§ μ μ©ν•  μ μλ‹¤.
@file:JvmName("StringFuctions")

μλ°”μ™€ λ‹¬λ¦¬ μ½”ν‹€λ¦°μ—μ„λ” μ• λ…Έν…μ΄μ… μΈμλ΅ ν΄λμ¤λ‚ ν•¨μ μ„ μ–Έμ΄λ‚ νƒ€μ… μ™Έμ— μ„μμ μ‹μ„ ν—μ©ν•λ‹¤.
ν•μ „ν•μ§€ λ»ν• μΊμ¤ν… κ²½κ³ λ¥Ό λ¬΄μ‹ν•λ” λ΅μ»¬ λ³€μ μ„ μ–Έ
@Suppress("UNCHECKED_CAST")
val strings = list as List<String>
```

<aside>
π’΅ μλ°” APIλ¥Ό μ• λ…Έν…μ΄μ…μΌλ΅ μ μ–΄ν•κΈ°
μ½”ν‹€λ¦°μ€ μ½”ν‹€λ¦°μΌλ΅ μ„ μ–Έν• λ‚΄μ©μ„ μλ°” λ°”μ΄νΈμ½”λ“λ΅ μ»΄νμΌν•λ” λ°©λ²•κ³Ό μ½”ν‹€λ¦° μ„ μ–Έμ„ μλ°”μ— λ…Έμ¶ν•λ” λ°©λ²•μ„ μ μ–΄ν•κΈ° μ„ν• μ• λ…Έν…μ΄μ…μ„ λ§μ΄ μ κ³µν•λ‹¤.
- @JvamName : μλ°” ν•„λ“λ‚ λ©”μ†λ“ μ΄λ¦„μ„ λ³€κ²½ν•λ‹¤.
- @JvmStatic : λ©”μ†λ“, κ°μ²΄ μ„ μ–Έ, λ™λ° κ°μ²΄μ— μ μ©ν•λ©΄ μλ°” μ •μ  λ©”μ†λ“λ΅ λ…Έμ¶ λλ‹¤.
- @JvmOverloads : λ””ν΄νΈ νλΌλ―Έν„° κ°’μ΄ μλ” ν•¨μμ— λ€ν•΄ μ»΄νμΌλ¬κ°€ μλ™μΌλ΅ μ¤λ²„λ΅λ”©ν• ν•¨μλ¥Ό μƒμ„±ν•΄ μ¤€λ‹¤.
- @JvmField : κ²ν„°λ‚ μ„Έν„°κ°€ μ—†λ” κ³µκ°λ(public) μλ°” ν•„λ“λ΅ ν”„λ΅νΌν‹°λ¥Ό λ…Έμ¶μ‹ν‚¨λ‹¤.

</aside>

### μ• λ…Έν…μ΄μ…μ„ ν™μ©ν• JSON μ§λ ¬ν™” μ μ–΄

- `μ§λ ¬ν™”` λ” κ°μ²΄λ¥Ό μ €μ¥μ¥μΉμ— μ €μ¥ν•κ±°λ‚ λ„¤νΈμ›ν¬λ¥Ό ν†µν•΄ μ „μ†΅ν•κΈ° μ„ν•΄ ν…μ¤νΈλ‚ μ΄μ§„ ν•μ‹μΌλ΅ λ³€ν™ν•λ” κ²ƒμ΄λ‹¤. μ—­μ§λ ¬ν™”λ” ν…μ¤νΈλ‚ μ΄μ§„ ν•μ‹μΌλ΅ μ €μ¥λ λ°μ΄ν„°λ΅λ¶€ν„° μ›λμ κ°μ²΄λ¥Όλ§λ“¤μ–΄ λ‚Έλ‹¤.
- μμ μ½”ν‹€λ¦° λΌμ΄λΈλ¬λ¦¬μΈ μ μ΄ν‚¤λ“ κµ¬ν„κ³Όμ •μ„ ν†µν•΄ μ•μ•„λ³΄μ

```kotlin
data class Person(val name: String, val age: Int)
val person = Person("Alice", 29)
println(serialize(person))
>>> {"age":29, "name":"Alice"}

val json = """
    "name": "Alice",
    "age": 29
""".trimIndent()
println(deserialize<Person>(json))
>>> Person(name=Alice, age=29)
```

- JSONμ—λ” κ°μ²΄μ νƒ€μ…μ΄ μ €μ¥λμ§€ μ•κΈ° λ•λ¬Έμ— JSON λ°μ΄ν„°λ΅λ¶€ν„° μΈμ¤ν„΄μ¤λ¥Ό λ§λ“¤λ ¤λ©΄ νƒ€μ… μΈμλ΅ ν΄λμ¤λ¥Ό λ…μ‹ν•΄μ•Ό ν•λ‹¤.
- μ• λ…Έν…μ΄μ…μ„ ν™μ©ν•΄ κ°μ²΄λ¥Ό μ§λ ¬ν™”ν•κ±°λ‚ μ—­μ§λ ¬ν™”ν•λ” λ°©λ²•μ„ μ μ–΄ν•  μ μλ‹¤.
    - @JsonExclude μ• λ…Έν…μ΄μ…μ„ μ‚¬μ©ν•λ©΄ μ§λ ¬ν™”λ‚ μ—­μ§λ ¬ν™” μ‹ κ·Έ ν”„λ΅νΌν‹°λ¥Ό λ¬΄μ‹ ν•  μ μλ‹¤.
    - @JsonName μ• λ…Έν…μ΄μ…μ„ μ‚¬μ©ν•λ©΄ ν”„λ΅νΌν‹°λ¥Ό ν‘ν„ν•λ” ν‚¤/κ°’ μμ ν‚¤λ΅ ν”„λ΅νΌν‹° μ΄λ¦„ λ€μ‹  μ• λ…Έν…μ΄μ…μ΄ μ§€μ •ν• μ΄λ¦„μ„ μ“°κ² ν•  μ μλ‹¤.

```kotlin
data class Person(
    @JsonName("alias")
    val firstName: String, 
    @JsonExclude
    val age: Int? = null
)
```

### μ• λ…Έν…μ΄μ… μ„ μ–Έ

- μ μ΄ν‚¤λ“μ μ• λ…Έν…μ΄μ…μ„ μμ λ΅ μ• λ…Έν…μ΄μ…μ„ μ„ μ–Έν•λ” λ°©λ²•μ„ μ‚΄ν‘ν•μ.
- @JsonExclude μ• λ…Έν…μ΄μ…μ€ μ•„λ¬΄ νλΌλ―Έν„°λ„ μ—†λ” κ°€μ¥ λ‹¨μν• μ• λ…Έν…μ΄μ…μ΄λ‹¤.

```kotlin
annotation class JsonExclude
```

- μ• λ…Έν…μ΄μ… ν΄λμ¤λ” μ¤μ§ μ„ μ–Έμ΄λ‚ μ‹κ³Ό κ΄€λ ¨ μλ” λ©”νƒ€λ°μ΄ν„°μ κµ¬μ΅°λ¥Ό μ •μν•κΈ° λ•λ¬Έμ— λ‚΄λ¶€μ— μ•„λ¬΄ μ½”λ“λ„ λ“¤μ–΄μμ„ μ μ—†λ‹¤. κ·Έλ° μ΄μ λ΅ μ»΄νμΌλ¬λ” μ• λ…Έν…μ΄μ… ν΄λμ¤μ—μ„ λ³Έλ¬Έμ„ μ •μν•μ§€ λ»ν•κ² λ§‰λ”λ‹¤.

```kotlin
annotation class JsonName(val name: String)
```

- νλΌλ―Έν„°κ°€ μλ” μ• λ…Έν…μ΄μ…μ„ μ •μν•λ ¤λ©΄ μ£Ό μƒμ„±μμ— νλΌλ―Έν„°λ¥Ό μ„ μ–Έν•΄μ•Ό ν•λ‹¤.
- μΌλ° ν΄λμ¤μ μ£Ό μƒμ„±μ μ„ μ–Έ κµ¬λ¬Έμ„ λ‘κ°™μ΄ μ‚¬μ©ν•λ‹¤. λ‹¤λ§ μ• λ…Έν…μ΄μ… ν΄λμ¤μ—μ„λ” λ¨λ“  νλΌλ―Έν„° μ•μ— `val` μ„ λ¶™μ—¬μ•Όλ§ ν•λ‹¤.

### λ©”νƒ€μ• λ…Έν…μ΄μ…: μ• λ…Έν…μ΄μ…μ„ μ²λ¦¬ν•λ” λ°©λ²• μ μ–΄

- μλ°”μ™€ λ§μ°¬κ°€μ§€λ΅ μ½”ν‹€λ¦° μ• λ…Έν…μ΄μ… ν΄λμ¤μ—λ„ μ• λ…Έν…μ΄μ…μ„ λ¶™μΌ μ μλ‹¤. μ• λ…Έν…μ΄μ… ν΄λμ¤μ— μ μ©ν•  μ μλ” μ• λ…Έν…μ΄μ…μ„ `λ©”νƒ€μ• λ…Έν…μ΄μ…` μ΄λΌκ³  ν•λ‹¤.
- ν‘μ¤€ λΌμ΄λΈλ¬λ¦¬μ—λ” λ‡ κ°€μ§€ λ©”νƒ€μ• λ…Έν…μ΄μ…μ΄ μμΌλ©°, κ·Έλ° λ©”νƒ€μ• λ…Έν…μ΄μ…λ“¤μ€ μ»΄νμΌλ¬κ°€ μ• λ…Έν…μ΄μ…μ„ μ²λ¦¬ν•λ” λ°©λ²•μ„ μ μ–΄ν•λ‹¤.
- κ°€μ¥ ν”ν μ“°μ΄λ” λ©”νƒ€μ• λ…Έν…μ΄μ…μ€ `@Target` μ΄λ‹¤. μ μ΄ν‚¤λ“μ JsonExcludeμ™€ JsonName μ• λ…Έν…μ΄μ…λ„ μ μ© κ°€λ¥ λ€μƒμ„ μ§€μ •ν•κΈ° μ„ν•΄ @Targetμ„ μ‚¬μ©ν•λ‹¤.

```kotlin
@Target(AnnotationTarget.PROPERTY)
annotation class JsonExclude
```

- μ• λ…Έν…μ΄μ…μ΄ λ¶™μ„ μ μλ” λ€μƒμ΄ μ •μλ μ΄λ„(enum)μ€ AnnotationTargetμ΄λ‹¤.κ·Έ μ•μ—λ” ν΄λμ¤, νμΌ, ν”„λ΅νΌν‹°, ν”„λ΅νΌν‹° μ ‘κ·Όμ, νƒ€μ…, μ‹ λ“±μ— λ€ν• μ΄λ„ μ •μκ°€ λ“¤μ–΄ μλ‹¤. ν•„μ”ν•λ‹¤λ©΄ λ‘ μ΄μƒμ λ€μƒμ„ ν•κΊΌλ²μ— μ„ μ–Έν•  μ λ„ μλ‹¤.
- λ©”νƒ€μ• λ…Έν…μ΄μ…μ„ μ§μ ‘ λ§λ“¤μ–΄μ•Ό ν•λ‹¤λ©΄ `ANNOTATION_CLASS`λ¥Ό λ€μƒμΌλ΅ μ§€μ •ν•λΌ

```kotlin
@Target(AnnotationTarget.ANNOTATION_CALSS)
annotation class BindingAnnotation

@BindingAnnotation
annotation class MyBinding
```

- λ€μƒμ„ PROPERTYλ΅ μ§€μ •ν• μ• λ…Έν…μ΄μ…μ„ μλ°” μ½”λ“μ—μ„ μ‚¬μ©ν•  μλ” μ—†λ‹¤. μλ°”μ—μ„ κ·Έλ° μ• λ…Έν…μ΄μ…μ„ μ‚¬μ©ν•λ ¤λ©΄ AnnotationTarget.FIELDλ¥Ό λ‘ λ² μ§Έ λ€μƒμΌλ΅ μ¶”κ°€ν•΄μ•Ό ν•λ‹¤.

<aside>
π’΅ @Retention μ• λ…Έν…μ΄μ…
μλ°” Retention μ• λ…Έν…μ΄μ…μ„ λ³Έ μ μ΄ μμ„ κ²ƒμ΄λ‹¤. @Retentionμ€ μ •μ μ¤‘μΈ μ• λ…Έν…μ΄μ… ν΄λμ¤λ¥Ό μ†μ¤ μμ¤€μ—μ„λ§ μ μ§€ν• μ§€, .class νμΌμ— μ €μ¥ν• μ§€, μ‹¤ν–‰ μ‹μ μ— λ¦¬ν”λ ‰μ…μ„ μ‚¬μ©ν•΄ μ ‘κ·Όν•  μ μκ² ν• μ§€λ¥Ό μ§€μ •ν•λ” λ©”νƒ€μ• λ…Έν…μ΄μ…μ΄λ‹¤.

μλ°” μ»΄νμΌλ¬λ” κΈ°λ³Έμ μΌλ΅ μ• λ…Έν…μ΄μ…μ„ .class νμΌμ—λ” μ €μ¥ν•μ§€λ§ λ°νƒ€μ„μ—λ” μ‚¬μ©ν•  μ μ—†κ² ν•λ‹¤. ν•μ§€λ§ λ€λ¶€λ¶„μ μ• λ…Έν…μ΄μ…μ€ λ°νƒ€μ„μ—λ„ μ‚¬μ©ν•  μ μμ–΄μ•Ό ν•λ―€λ΅ μ½”ν‹€λ¦°μ—μ„λ” κΈ°λ³Έμ μΌλ΅ μ• λ…Έν…μ΄μ…μ @Retentionμ„ RUNTIMEμΌλ΅ μ €μ¥ν•λ‹¤.

</aside>

### μ• λ…Έν…μ΄μ… νλΌλ―Έν„°λ΅ ν΄λμ¤ μ‚¬μ©

- μ •μ μΈ λ°μ΄ν„°λ¥Ό μΈμλ΅ μ μ§€ν•λ” μ• λ…Έν…μ΄μ…μ„ μ •μν•λ” λ°©λ²•μ„ μ§€κΈκΉμ§€ μ‚΄ν΄λ΄¤λ‹¤.
- ν•μ§€λ§ μ–΄λ–¤ ν΄λμ¤λ¥Ό μ„ μ–Έ λ©”νƒ€λ°μ΄ν„°λ΅ μ°Έμ΅°ν•  μ μλ” κΈ°λ¥μ΄ ν•„μ”ν•  λ•λ„ μλ‹¤.
- ν΄λμ¤ μ°Έμ΅°λ¥Ό νλΌλ―Έν„°λ΅ ν•λ” μ• λ…Έν…μ΄μ… ν΄λμ¤λ¥Ό μ„ μ–Έν•λ©΄ κ·Έλ° κΈ°λ¥μ„ μ‚¬μ©ν•  μ μλ‹¤.
- μ μ΄ν‚¤λ“ λΌμ΄λΈλ¬λ¦¬μ— μλ” `@DeserializeInterface` λ” μΈν„°νμ΄μ¤ νƒ€μ…μΈ ν”„λ΅νΌν‹°μ— λ€ν• μ—­μ§λ ¬ν™”λ¥Ό μ μ–΄ν•  λ• μ“°λ” μ• λ…Έν…μ΄μ…μ΄λ‹¤.

```kotlin
interface Company {
    val name: String
}
data class CompanyImpl(override val name: String): Company
data class Person(
    val name: String,
    @DeserializeInterface(CompanyImpl::class) val company: Company
)
```

- μ§λ ¬ν™”λ Person μΈμ¤ν„΄μ¤λ¥Ό μ—­μ§λ ¬ν™”ν•λ” κ³Όμ •μ—μ„ company ν”„λ΅νΌν‹°λ¥Ό ν‘ν„ν•λ” JSONμ„ μ½μΌλ©΄ μ μ΄ν‚¤λ“λ” κ·Έ ν”„λ΅νΌν‹° κ°’μ— ν•΄λ‹Ήν•λ” JSONμ„ μ—­μ§λ ¬ν™”ν•λ©΄μ„ CompanyImplμ μΈμ¤ν„΄μ¤λ¥Ό λ§λ“¤μ–΄μ„ Person μΈμ¤ν„΄μ¤μ company ν”„λ΅νΌν‹°μ— μ„¤μ •ν•λ‹¤.
    - μ΄λ ‡κ² μ—­μ§λ ¬ν™”λ¥Ό μ‚¬μ©ν•  ν΄λμ¤λ¥Ό μ§€μ •ν•κΈ° μ„ν•΄ μΈμλ΅ `CompanyImpl::class` λ¥Ό λ„κΈ΄λ‹¤

```kotlin
annotation class DeserializeInterface(val targetClass: KClass<out Any>)
```

- KClassλ” μλ°” java.lang.Class νƒ€μ…κ³Ό κ°™μ€ μ—­ν• μ„ ν•λ” μ½”ν‹€λ¦° νƒ€μ…μ΄λ‹¤. μ½”ν‹€λ¦° ν΄λμ¤μ— λ€ν• μ°Έμ΅°λ¥Ό μ €μ¥ν•  λ• KClass νƒ€μ…μ„ μ‚¬μ©ν•λ‹¤.

### μ• λ…Έν…μ΄μ… νλΌλ―Έν„°λ΅ μ λ„¤λ¦­ ν΄λμ¤ λ°›κΈ°

- κΈ°λ³Έμ μΌλ΅ μ μ΄ν‚¤λ“λ” μ›μ‹ νƒ€μ…μ΄ μ•„λ‹ ν”„λ΅νΌν‹°λ¥Ό μ¤‘μ²©λ κ°μ²΄λ΅ μ§λ ¬ν™”ν•λ‹¤. μ΄λ° κΈ°λ³Έ λ™μ‘μ„ λ³€κ²½ν•κ³  μ‹¶μΌλ©΄ κ°’μ„ μ§λ ¬ν™”ν•λ” λ΅μ§μ„ μ§μ ‘ μ κ³µν•λ©΄ λλ‹¤.
- @CustomSerializer μ• λ…Έν…μ΄μ…μ€ μ»¤μ¤ν…€ μ§λ ¬ν™” ν΄λμ¤μ— λ€ν• μ°Έμ΅°λ¥Ό μΈμλ΅ λ°›λ”λ‹¤. μ΄ μ§λ ¬ν™” ν΄λμ¤λ” ValueSerializer μΈν„°νμ΄μ¤λ¥Ό κµ¬ν„ν•΄μ•Ό ν•λ‹¤.

```kotlin
interface ValueSerializer<T> {
    fun toJsonValue(value: T): Any?
    fun gromJsonValue(jsonValue: Any?): T
}

data class Person(
    val name: String,
    @CustomSerializer(DateSerializer::class)
    val birthDate: Date
)
```

- ValueSerializerν΄λμ¤λ” μ λ„¤λ¦­ ν΄λμ¤λΌμ„ νƒ€μ… νλΌλ―Έν„°κ°€ μλ‹¤. μ΄ μ• λ…Έν…μ΄μ…μ΄ μ–΄λ–¤ νƒ€μ…μ— λ€ν•΄ μ“°μΌμ§€ μ• μ μ—†μΌλ―€λ΅ μ—¬κΈ°μ„λ” μ¤νƒ€ ν”„λ΅μ μ…μ„ μ‚¬μ©ν•  μ μλ‹¤.

```kotlin
annotation class CustomSerializer(
    val serializerClass: KClass<out ValueSerializer<*>>
)
```

## π“Β λ¦¬ν”λ ‰μ…: μ‹¤ν–‰ μ‹μ μ— μ½”ν‹€λ¦° κ°μ²΄ λ‚΄λ¶€ κ΄€μ°°

- κ°„λ‹¨ν λ§ν•΄ λ¦¬ν”λ ‰μ…μ€ μ‹¤ν–‰ μ‹μ μ— κ°μ²΄μ ν”„λ΅νΌν‹°μ™€ λ©”μ†λ“μ— μ ‘κ·Όν•  μ μκ² ν•΄μ£Όλ” λ°©λ²•μ΄λ‹¤. νƒ€μ…κ³Ό κ΄€κ³„μ—†μ΄ κ°μ²΄λ¥Ό λ‹¤λ¤„μ•Ό ν•κ±°λ‚ κ°μ²΄κ°€ μ κ³µν•λ” λ©”μ†λ“λ‚ ν”„λ΅νΌν‹° μ΄λ¦„μ„ μ¤μ§ μ‹¤ν–‰ μ‹μ μ—λ§ μ• μ μλ” κ²½μ°κ°€ μλ‹¤ (ex. JSON μ§λ ¬ν™” λΌμ΄λΈλ¬λ¦¬)
- μ§λ ¬ν™” λΌμ΄λΈλ¬λ¦¬λ” μ–΄λ–¤ κ°μ²΄λ“  JSONμΌλ΅ λ³€ν™ν•  μ μμ–΄μ•Όν•κ³ , μ‹¤ν–‰ μ‹μ μ΄ λκΈ° μ „κΉμ§€λ” λΌμ΄λΈλ¬λ¦¬κ°€ μ§λ ¬ν™”ν•  ν”„λ΅νΌν‹°λ‚ ν΄λμ¤μ— λ€ν• μ •λ³΄λ¥Ό μ• μ μ—†λ‹¤. μ΄λ¬ν• κ²½μ° λ¦¬ν”λ ‰μ…μ„ μ‚¬μ©ν•΄μ•Ό ν•λ‹¤.
- μ½”ν‹€λ¦°μ—μ„ λ¦¬ν”λ ‰μ…μ„ μ‚¬μ©ν•λ ¤λ©΄ λ‘ κ°€μ§€ μ„λ΅ λ‹¤λ¥Έ λ¦¬ν”λ ‰μ… APIλ¥Ό λ‹¤λ¤„μ•Ό ν•λ‹¤.
1. μλ°”κ°€ `java.lang.reflect` ν¨ν‚¤μ§€λ¥Ό ν†µν•΄ μ κ³µν•λ” ν‘μ¤€ λ¦¬ν”λ ‰μ…μ΄λ‹¤. μ½”ν‹€λ¦° ν΄λμ¤λ” μΌλ° μλ°” λ°”μ΄νΈμ½”λ“λ΅ μ»΄νμΌλλ―€λ΅ μλ°” λ¦¬ν”λ ‰μ… APIλ„ μ½”ν‹€λ¦° ν΄λμ¤λ¥Ό μ»΄νμΌν• λ°”μ΄νΈμ½”λ“λ¥Ό μ™„λ²½ν μ§€μ›ν•λ‹¤. μ΄λ” λ¦¬ν”λ ‰μ…μ„ μ‚¬μ©ν•λ” μλ°” λΌμ΄λΈλ¬λ¦¬μ™€ μ½”ν‹€λ¦° μ½”λ“κ°€ μ™„μ „ν νΈν™λλ‹¤λ” λ»μ΄λ―€λ΅ νΉν μ¤‘μ”ν•λ‹¤.
2. μ½”ν‹€λ¦°μ΄ `kotlin.reflect` ν¨ν‚¤μ§€λ¥Ό ν†µν•΄ μ κ³µν•λ” μ½”ν‹€λ¦° λ¦¬ν”λ ‰μ… APIμ΄λ‹¤. μ΄ APIλ” μλ°”μ—λ” μ—†λ” ν”„λ΅νΌν‹°λ‚ λ„μ΄ λ  μ μλ” νƒ€μ…κ³Ό κ°™μ€ μ½”ν‹€λ¦° κ³ μ  κ°λ…μ— λ€ν• λ¦¬ν”λ ‰μ…μ„ μ κ³µν•λ‹¤. ν•μ§€λ§ ν„μ¬ μ½”ν‹€λ¦° λ¦¬ν”λ ‰μ… APIλ” μλ°” λ¦¬ν”λ ‰μ… APIλ¥Ό μ™„μ „ν λ€μ²΄ν•  μ μλ” λ³µμ΅ν• κΈ°λ¥μ„ μ κ³µν•μ§€λ” μ•λ”λ‹¤.

<aside>
π’΅ μ•λ“λ΅μ΄λ“μ™€ κ°™μ΄ λ°νƒ€μ„ λΌμ΄λΈλ¬λ¦¬ ν¬κΈ°κ°€ λ¬Έμ κ°€ λλ” ν”λ«νΌμ„ μ„ν•΄ μ½”ν‹€λ¦° λ¦¬ν”λ ‰μ… APIλ” kotlin-reflect.jar λΌλ” λ³„λ„μ .jar νμΌμ— λ‹΄κ²¨ μ κ³µλλ©°, μƒ ν”„λ΅μ νΈλ¥Ό μƒμ„±ν•  λ• λ¦¬ν”λ ‰μ… ν¨ν‚¤μ§€ .jar νμΌμ— λ€ν• μμ΅΄κ΄€κ³„κ°€ μλ™μΌλ΅ μ¶”κ°€λλ” μΌμ€ μ—†λ‹¤. λ”°λΌμ„ μ½”ν‹€λ¦° λ¦¬ν”λ ‰μ… APIλ¥Ό μ‚¬μ©ν•λ‹¤λ©΄ μ§μ ‘ ν”„λ΅μ νΈ μμ΅΄κ΄€κ³„μ— λ¦¬ν”λ ‰μ… .jar νμΌμ„ μ¶”κ°€ν•΄μ•Ό ν•λ‹¤.

</aside>

### μ½”ν‹€λ¦° λ¦¬ν”λ ‰μ… API: KClass, KCallable, KFunction, KProperty

- μ½”ν‹€λ¦° λ¦¬ν”λ ‰μ… APIλ¥Ό μ‚¬μ©ν•  λ• μ²μ μ ‘ν•κ² λλ” κ²ƒμ€ ν΄λμ¤λ¥Ό ν‘ν„ν•λ” `KClass` λ‹¤.
- java.lang.Classμ— ν•΄λ‹Ήν•λ” KClassλ¥Ό μ‚¬μ©ν•λ©΄ ν΄λμ¤ μ•μ— μλ” λ¨λ“  μ„ μ–Έμ„ μ—΄κ±°ν•κ³  κ° μ„ μ–Έμ— μ ‘κ·Όν•κ±°λ‚ ν΄λμ¤μ μƒμ„ ν΄λμ¤λ¥Ό μ–»λ” λ“±μ μ‘μ—…μ΄ κ°€λ¥ν•λ‹¤.
- MyClass::class λΌλ” μ‹μ„ μ“°λ©΄ KClassμ μΈμ¤ν„΄μ¤λ¥Ό μ–»μ„ μ μλ‹¤. μ‹¤ν–‰ μ‹μ μ— κ°μ²΄μ ν΄λμ¤λ¥Ό μ–»μΌλ¬λ©΄ λ¨Όμ € κ°μ²΄μ javaClass ν”„λ΅νΌν‹°λ¥Ό μ‚¬μ©ν•΄ κ°μ²΄μ μλ°” ν΄λμ¤λ¥Ό μ–»μ–΄μ•Ό ν•λ‹¤. javaClassλ” μλ°”μ java.lang.Object.getClass()μ™€ κ°™λ‹¤. μ΄ ν›„ .kotlin ν™•μ¥ ν”„λ΅νΌν‹°λ¥Ό ν†µν•΄ μλ°”μ—μ„ μ½”ν‹€λ¦° λ¦¬ν”λ ‰μ… APIλ΅ μ®κ²¨μ¬ μ μλ‹¤.

```kotlin
class Person(val name: String, val age: Int)
val person = Person("Alice", 29)
val kClass = person.javaClass.kotlin // KClass<Person> μΈμ¤ν„΄μ¤ λ°ν™

println(kClass.simpleName)
kClass.memberProperties.forEach { println(it.name) }
>>> Person
>>> age
>>> name

interface KClass<T: Any> {
    val simpleName: String?
    val qualifiedName: String?
    val members: Collection<KCallable<*>>
    val constructors: Collection<KFunction<T>>
    val nestedClasses: Collection<KClass<*>>
    ...
}
```

- ν΄λμ¤μ λ¨λ“  λ©¤λ²„μ λ©λ΅μ΄ `KCallable` μΈμ¤ν„΄μ¤μ μ»¬λ ‰μ…μΌλ΅ λμ–΄μλ” κ²ƒμ„ λ³Ό μ μλ‹¤. KCallableμ€ ν•¨μμ™€ ν”„λ΅νΌν‹°λ¥Ό μ•„μ°λ¥΄λ” κ³µν†µ μƒμ„ μΈν„°νμ΄μ¤λ‹¤. κ·Έ μ•μ—λ” call λ©”μ†λ“κ°€ λ“¤μ–΄μλ‹¤. callμ„ μ‚¬μ©ν•λ©΄ ν•¨μλ‚ ν”„λ΅νΌν‹°μ κ²ν„°λ¥Ό νΈμ¶ν•  μ μλ‹¤.

```kotlin
interface KCallable<out R> {
    fun call(vararg args: Any?): R
    ...
}
```

- call μ„ μ‚¬μ©ν•  λ•λ” ν•¨μ μΈμλ¥Ό vararg λ¦¬μ¤νΈλ΅ μ „λ‹¬ν•λ‹¤.

```kotlin
fun foo(x: Int) = println(x)
>>> val kFunction = ::foo
>>> kFunction.call(42)
>>> 42
```

- μ΄ ν•¨μ μ°Έμ΅°κ°€ κ°€λ¦¬ν‚¤λ” ν•¨μλ¥Ό νΈμ¶ν•λ ¤λ©΄ [`KCallable.call`](http://KCallable.call) λ©”μ†λ“λ¥Ό νΈμ¶ν•λ‹¤.
- callμ— λ„κΈ΄ μΈμ κ°μμ™€ μ›λ ν•¨μμ— μ •μλ νλΌλ―Έν„° κ°μκ°€ λ§μ•„ λ–¨μ–΄μ Έμ•Ό ν•λ‹¤.
- ::fooμ νƒ€μ… KFuction1<Int, Unit>μ—λ” νλΌλ―Έν„°μ™€ λ°ν™ κ°’ νƒ€μ… μ •λ³΄κ°€ λ“¤μ–΄μλ‹¤. KFunction1 μΈν„°νμ΄μ¤λ¥Ό ν†µν•΄ ν•¨μλ¥Ό νΈμ¶ν•λ ¤λ©΄ invoke λ©”μ†λ“λ¥Ό μ‚¬μ©ν•΄μ•Ό ν•λ‹¤.

```kotlin
fun sum(x: Int, y: Int) = x + y

val kFunction: KFunction2<Int, Int, Int> = ::sum
println(kFunction.invoke(1, 2) + kFunction(3, 4))
>>> 10
kFunction(1)
>> ERROR: No value passed for parameter p2
```

<aside>
π’΅ μ–Έμ , μ–΄λ–»κ² KFuctionN μΈν„°νμ΄μ¤κ°€ μ •μλλ”κ°€?
KFunction1κ³Ό κ°™μ€ νƒ€μ…μ€ νλΌλ―Έν„° κ°μκ°€ λ‹¤λ¥Έ μ—¬λ¬ ν•¨μλ¥Ό ν‘ν„ν•λ‹¤. κ° KFuctionN νƒ€μ…μ€ KFunctionμ„ ν™•μ¥ν•λ©°, Nκ³Ό νλΌλ―Έν„° κ°μκ°€κ°™μ€ invokeλ¥Ό μ¶”κ°€λ΅ ν¬ν•¨ν•λ‹¤. μλ¥Ό λ“¤μ–΄ KFuction2<P1, P2, R>μ—λ” operator fun invoke(p1: P1, p2: P2): R μ„ μ–Έμ΄ λ“¤μ–΄ μλ‹¤.

</aside>

- KPropertyμ call λ©”μ†λ“λ¥Ό νΈμ¶ν•  μλ„ μλ‹¤. KPropertyμ callμ€ ν”„λ΅νΌν‹°μ κ²ν„°λ¥Ό νΈμ¶ν•λ‹¤. ν”„λ΅νΌν‹° μΈν„°νμ΄μ¤λ” ν”„λ΅νΌν‹° κ°’μ„ μ–»λ” λ” μΆ‹μ€ λ°©λ²•μΌλ΅ get λ©”μ†λ“λ¥Ό μ κ³µν•λ‹¤.

```kotlin
var counter = 0
val kProperty = ::counter
kProperty.setter.call(21) // reflectionμ„ μ‚¬μ©ν•΄μ„ setterλ¥Ό ν†µν•΄ 21μ„ μΈμλ΅ λ„κΈ΄λ‹¤.
println(kProperty.get()) // getμ„ νΈμ¶ν•΄ ν”„λ΅νΌν‹° κ°’μ„ κ°€μ Έμ¨λ‹¤.
```

- λ©¤λ²„ ν”„λ΅νΌν‹°λ” KProperty1 μΈμ¤ν„΄μ¤λ΅ ν‘ν„λλ‹¤. κ·Έ μ•μ—λ” μΈμκ°€ 1κ°μΈ get λ©”μ†λ“κ°€ λ“¤μ–΄ μλ‹¤. λ©¤λ²„ ν”„λ΅νΌν‹°λ” μ–΄λ–¤ κ°μ²΄μ— μ†ν•΄ μλ” ν”„λ΅νΌν‹°μ΄λ―€λ΅ λ©¤λ²„ ν”„λ΅νΌν‹°μ κ°’μ„ κ°€μ Έμ¤λ ¤λ©΄ get λ©”μ†λ“μ—κ² ν”„λ΅νΌν‹°λ¥Ό μ–»κ³ μ ν•λ” κ°μ²΄ μΈμ¤ν„΄μ¤λ¥Ό λ„κ²¨μ•Ό ν•λ‹¤.

```kotlin
class Person(val name: String, val age: Int)

val person = Person("Alice", 29)
val memberProperty = Person::age
println(memberProperty.get(person))
>>> 29
```

- KProperty1μ€ μ λ„¤λ¦­ ν΄λμ¤λ‹¤. memberProperty λ³€μλ” KProperty<Person, Int> νƒ€μ…μ΄λ‹¤.
- μµμƒμ„ μμ¤€μ΄λ‚ ν΄λμ¤ μ•μ— μ •μλ ν”„λ΅νΌν‹°λ§ λ¦¬ν”λ ‰μ…μΌλ΅ μ ‘κ·Όν•  μ μκ³  ν•¨μμ λ΅μ»¬ λ³€μμ—λ” μ ‘κ·Όν•  μ μ—†λ‹¤λ” μ μ„ μ•μ•„λ‘μ–΄μ•Ό ν•λ‹¤. λ΅μ»¬ λ³€μλ¥Ό μ •μν•κ³  μ°Έμ΅°λ¥Ό μ–»μΌλ ¤ν•λ©΄ `"References to variables aren't supported yet"` μ¤λ¥λ¥Ό λ³Ό μ μλ‹¤.

<img src="https://github.com/ppeper/ppeper/assets/63226023/65216f0c-d7a7-4ca9-8d20-ede0362083d6">

### λ¦¬ν”λ ‰μ…μ„ μ‚¬μ©ν• κ°μ²΄ μ§λ ¬ν™” κµ¬ν„

- μ μ΄ν‚¤λ“μ κ°μ²΄ μ§λ ¬ν™” ν•κΈ°

```kotlin
 private fun StringBuilder.serializeObject(obj: Any) {
    val kClass = obj.javaClass.kotlin // κ°μ²΄μ KClassλ¥Ό μ–»λ”λ‹¤.
    val properties = kClass.memberProperties // ν΄λμ¤μ λ¨λ“  ν”„λ΅νΌν‹°λ¥Ό μ–»λ”λ‹¤.

    properties.joinToString(
        this, prefix = "{", postfix = "}"
    ) { prop ->
        serializeString(prop.name) // ν”„λ΅νΌν‹° μ΄λ¦„μ„ μ–»λ”λ‹¤.
        append(": ")
        serializePropertyValue(prop.get(obj)) // ν”„λ΅νΌν‹° κ°’μ„ μ–»λ”λ‹¤.
    }
}
```

### μ• λ…Έν…μ΄μ…μ„ ν™μ©ν• μ§λ ¬ν™” μ μ–΄

- @JsonExclude μ• λ…Έν…μ΄μ…μ΄ λ¶™μ€ ν”„λ΅νΌν‹°λ¥Ό μ μ™Έν•΄μ•Ό ν•λ―€λ΅ μ‚΄μ§ λ³µμ΅ν•΄ μ§„λ‹¤. μ–΄λ–»κ² νΉμ • μ• λ…Έν…μ΄μ…μ΄ λ¶™μ€ ν”„λ΅νΌν‹°λ¥Ό μ μ™Έν•  μ μμ„κΉ?
- `KAnnotatedElement` μΈν„°νμ΄μ¤μ—λ” annotations ν”„λ΅νΌν‹°κ°€ μλ‹¤. KPropertyλ” KAnnotatedElementλ¥Ό ν™•μ¥ν•λ―€λ΅ property.annotationsλ¥Ό ν†µν•΄ ν”„λ΅νΌν‹°μ λ¨λ“  μ• λ…Έν…μ΄μ…μ„ μ–»μ„ μ μλ‹¤.

```kotlin
inline fun <reified T> KAnnotatedElement.findAnnotation(): T?
		= annotations.filterIsInstance<T>().firstOrNull()
```

- ν•΄λ‹Ή ν•¨μμ™€ ν‘μ¤€ λΌμ΄λΈλ¬λ¦¬ ν•¨μμΈ filterμ™€ ν•¨κ» μ‚¬μ©ν•λ©΄ @JsonExcludeλ΅ μ• λ…Έν…μ΄μ…λ ν”„λ΅νΌν‹°λ¥Ό μ—†μ•¨ μ μλ‹¤.

```kotlin
val properties = kClass.memberProperties
    .filter { it.findAnnotation<JsonExclude>() == null }
```

- μ§λ ¬ν™” μ΄λ¦„μ„ μ„ν• @JsonName λν• ν™•μΈν•΄ λ³΄μ

```kotlin
// @JsonName μ• λ…Έν…μ΄μ…μ΄ μμΌλ©΄ κ·Έ μΈμ¤ν„΄μ¤λ¥Ό μ–»λ”λ‹¤.
val jsonNameAnn = prop.findAnnotation<JsonName>()
// μ• λ…Έν…μ΄μ…μ—μ„ "name" μΈμλ¥Ό μ°Ύκ³  κ·Έλ° μΈμκ°€ μ—†μΌλ©΄ "prop.name"μ„ μ‚¬μ©
val propName = jsonNameAnn?.name ?: prop.name
```

- ν”„λ΅νΌν‹° ν•„ν„°λ§μ„ ν¬ν•¨ν•λ” κ°μ²΄ μ§λ ¬ν™”

```kotlin
private fun StringBuilder.serializeObject(obj: Any) {
    obj.javaClass.kotlin.memberProperties
        .filter { it.findAnnotation<JsonExclude>() == null }
        .joinToStringBuilder(this, prefix = "{", postfix = "}") {
            serializeProperty(it, obj)
        }
}

// ν”„λ΅νΌν‹°μ κ°’μ„ μ§λ ¬ν™”ν•λ” μ§λ ¬ν™”κΈ° κ°€μ Έμ¤κΈ°
fun KProperty<*>.getSerializer(): ValueSerializer<Any?>? {
    val customSerializerAnn = findAnnotation<CustomSerializer>() ?: return null
    val serializerClass = customSerializerAnn.serializerClass

    val valueSerializer = serializerClass.objectInstance
            ?: serializerClass.createInstance()
    @Suppress("UNCHECKED_CAST")
    return valueSerializer as ValueSerializer<Any?>
}

// ν”„λ΅νΌν‹° μ§λ ¬ν™”ν•κΈ°
private fun StringBuilder.serializeProperty(
        prop: KProperty1<Any, *>, obj: Any
) {
    val jsonNameAnn = prop.findAnnotation<JsonName>()
    val propName = jsonNameAnn?.name ?: prop.name
    serializeString(propName)
    append(": ")

    val value = prop.get(obj)
    val jsonValue = prop.getSerializer()?.toJsonValue(value) ?: value
    serializePropertyValue(jsonValue)
}

```

### JSON νμ‹±κ³Ό κ°μ²΄ μ—­μ§λ ¬ν™”

- μ—­μ§λ ¬ν™”ν•  κ°μ²΄μ νƒ€μ…μ„ μ‹¤μ²΄ν™”ν• νƒ€μ… νλΌλ―Έν„°λ΅ deserialize ν•¨μμ— λ„κ²¨μ„ μƒλ΅μ΄ κ°μ²΄ μΈμ¤ν„΄μ¤λ¥Ό μ–»λ”λ‹¤.
- JSON λ¬Έμμ—΄ μ…λ ¥μ„ νμ‹±ν•κ³ , λ¦¬ν”λ ‰μ…μ„ μ‚¬μ©ν•΄ κ°μ²΄μ λ‚΄λ¶€μ— μ ‘κ·Όν•΄μ„ μƒλ΅μ΄ ν”„λ΅νΌν‹°λ¥Ό μƒμ„±ν•κΈ° λ•λ¬Έμ— JSONμ„ μ—­μ§λ ¬ν™”ν•λ” κ²ƒμ„ μ§λ ¬ν™”λ³΄λ‹¤ λ” μ–΄λ µλ‹¤.
- μ μ΄ν‚¤λ“μ JSON μ—­μ§λ ¬ν™”κΈ°λ” ν”ν μ“°λ” λ°©λ²•μ„ λ”°λΌ 3λ‹¨κ³„λ΅ κµ¬ν„λμ–΄ μλ‹¤.
    1. μ–΄ν λ¶„μ„κΈ°(λ ‰μ„)
        1. μ—¬λ¬ λ¬Έμλ΅ μ΄λ¤„μ§„ μ…λ ¥ λ¬Έμμ—΄μ„ `ν† ν°` μ λ¦¬μ¤νΈλ΅ λ³€ν™ν•λ‹¤. ν† ν°μ—λ” 2κ°€μ§€ μΆ…λ¥κ°€ μλ‹¤.
        2. λ¬Έμ ν† ν°μ€ λ¬Έμλ¥Ό ν‘ν„ν•λ©° JSON λ¬Έλ²•μ—μ„ μ¤‘μ”ν• μλ―Έκ°€ μλ‹¤(μ½¤λ§, μ½λ΅ , μ¤‘κ΄„νΈ, κ°κ΄„νΈ λ“±)
        3. κ°’ ν† ν°μ€ λ¬Έμμ—΄, μ, λ¶λ¦¬μ–Έ κ°’, null μƒμλ¥Ό λ§ν•λ‹¤.
    2. λ¬Έλ²• λ¶„μ„κΈ°(νμ„)
        1. ν† ν°μ λ¦¬μ¤νΈλ¥Ό κµ¬μ΅°ν™”λ ν‘ν„μΌλ΅ λ³€ν™ν•λ‹¤. μ μ΄ν‚¤λ“μ—μ„ νμ„λ” JSONμ μƒμ„ κµ¬μ΅°λ¥Ό μ΄ν•΄ν•κ³  ν† ν°μ„ JSONμ—μ„ μ§€μ›ν•λ” μλ―Έ λ‹¨μ„λ΅ λ°ν™ν•λ” μΌμ„ ν•λ‹¤. κ·Έλ° μλ―Έ λ‹¨μ„λ΅λ” ν‚¤/κ°’ μκ³Ό λ°°μ—΄μ΄ μλ‹¤.
    3. νμ‹±ν• κ²°κ³Όλ΅ κ°μ²΄λ¥Ό μƒμ„±ν•λ” μ—­μ§λ ¬ν™” μ»΄ν¬λ„νΈ

```kotlin
interface JsonObject {
    fun setSimpleProperty(propertyName: String, value: Any?)
    fun createObject(propertyName: String): JsonObject
    fun createArray(propertyName: String): JsonObject
}
```

- JsonObject μΈν„°νμ΄μ¤λ” ν„μ¬ μ—­μ§λ ¬ν™”ν•λ” μ¤‘μΈ κ°μ²΄λ‚ λ°°μ—΄μ„ μ¶”μ ν•λ‹¤. νμ„λ” ν„μ¬ κ°μ²΄μ μƒλ΅μ΄ ν”„λ΅νΌν‹°λ¥Ό λ°κ²¬ν•  λ•λ§λ‹¤ κ·Έ ν”„λ΅νΌν‹°μ μ ν•μ— ν•΄λ‹Ήν•λ” JsonObjectμ ν•¨μλ¥Ό νΈμ¶ν•λ‹¤.
- κ° λ©”μ†λ“μ propertyName νλΌλ―Έν„°λ” JSON ν‚¤λ¥Ό λ°›λ”λ‹¤.

<img src="https://github.com/ppeper/ppeper/assets/63226023/79513d9c-91c8-4f81-bb2e-b1707e64a167">

```kotlin
// JSON λ°μ΄ν„°λ΅λ¶€ν„° κ°μ²΄λ¥Ό λ§λ“¤μ–΄λ‚΄κΈ° μ„ν• μΈν„°νμ΄μ¤
interface Seed: JsonObject {
    val classInfoCache: ClassInfoCache

    fun spawn(): Any?

    fun createCompositeProperty(propertyName: String, isList: Boolean): JsonObject

    override fun createObject(propertyName: String) = createCompositeProperty(propertyName, false)

    override fun createArray(propertyName: String) = createCompositeProperty(propertyName, true)
}
```

- spawnμ€ ObjectSeedμ κ²½μ° μƒμ„±λ κ°μ²΄λ¥Ό λ°ν™ν•κ³ , ObjectListSeedλ‚ ValueListSeedμ κ²½μ° μƒμ„±λ λ¦¬μ¤νΈλ¥Ό λ°ν™ν•λ‹¤.

```kotlin
fun <T: Any> deserialize(json: Reader, targetClass: KClass<T>): T {
    val seed = ObjectSeed(targetClass, ClassInfoCache())
    Parser(json, seed).parse()
    return seed.spawn()
}
```

- νμ‹±μ„ μ‹μ‘ν•λ ¤λ©΄ μ§λ ¬ν™”ν•  κ°μ²΄μ ν”„λ΅νΌν‹°λ¥Ό λ‹΄μ„ ObjectSeedλ¥Ό ν•λ‚ μƒμ„±ν•΄μ•Ό ν•λ‹¤. κ·Έλ¦¬κ³  νμ„λ¥Ό νΈμ¶ν•λ©΄μ„ μ…λ ¥ μ¤νΈλ¦Ό λ¦¬λ”μΈ jsonκ³Ό μ‹λ“λ¥Ό μΈμλ΅ μ „λ‹¬ν•΄μ•Ό ν•λ‹¤. μ…λ ¥ λ°μ΄ν„°μ λμ— λ„λ‹¬ν•λ©΄ spawn ν•¨μλ¥Ό νΈμ¶ν•΄μ„ κ²°κ³Ό κ°μ²΄λ¥Ό μƒμ„±ν•λ‹¤.
- κ°μ²΄μ μƒνƒλ¥Ό μ €μ¥ν•λ” ObjectSeed κµ¬ν„μ„ λ³΄μ

```kotlin
class ObjectSeed<out T: Any>(
        targetClass: KClass<T>,
        override val classInfoCache: ClassInfoCache
) : Seed {

		// targetClassμ μΈμ¤ν„΄μ¤λ¥Ό λ§λ“¤ λ• ν•„μ”ν• μ •λ³΄λ¥Ό μΊμ‹ν•λ‹¤.
    private val classInfo: ClassInfo<T> = classInfoCache[targetClass]

    private val valueArguments = mutableMapOf<KParameter, Any?>()
    private val seedArguments = mutableMapOf<KParameter, Seed>()

		// μƒμ„±μ νλΌλ―Έν„°μ™€ κ·Έ κ°’μ„ μ—°κ²°ν•λ” λ§µμ„ λ§λ“ λ‹¤.
    private val arguments: Map<KParameter, Any?>
        get() = valueArguments + seedArguments.mapValues { it.value.spawn() }

    override fun setSimpleProperty(propertyName: String, value: Any?) {
        val param = classInfo.getConstructorParameter(propertyName)
        // λ„μƒμ„±μ νλΌλ―Έν„° κ°’μ΄ κ°„λ‹¨ν• κ°’μΌ κ²½μ° κ·Έ κ°’μ„ κΈ°λ΅ν•λ‹¤.
        valueArguments[param] = classInfo.deserializeConstructorArgument(param, value)
    }

    override fun createCompositeProperty(propertyName: String, isList: Boolean): Seed {
        val param = classInfo.getConstructorParameter(propertyName)
        // ν”„λ΅νΌν‹°μ— λ€ν• DeserializeInterfce μ• λ…Έν…μ΄μ…μ΄ μλ‹¤λ©΄ κ·Έ κ°’μ„ κ°€μ Έμ¨λ‹¤.
        val deserializeAs = classInfo.getDeserializeClass(propertyName)
        // νλΌλ―Έν„° νƒ€μ…μ— λ”°λΌ ObjectSeedλ‚ CollectionSeedλ¥Ό λ§λ“ λ‹¤(1)
        val seed = createSeedForType(
                deserializeAs ?: param.type.javaType, isList)
        // (1)μ—μ„ λ§λ“  μ‹λ“ κ°μ²΄λ¥Ό seedArgument λ§µμ— κΈ°λ΅ν•λ‹¤.
        return seed.apply { seedArguments[param] = this }
    }
    
    // μΈμ λ§µμ„ λ„κ²¨μ„ targetClass νƒ€μ…μ μΈμ¤ν„΄μ¤λ¥Ό λ§λ“ λ‹¤.
    override fun spawn(): T = classInfo.createInstance(arguments)
}
```

### μµμΆ… μ—­μ§λ ¬ν™” λ‹¨κ³„: callBy(), λ¦¬ν”λ ‰μ…μ„ μ‚¬μ©ν•΄ κ°μ²΄ λ§λ“¤κΈ°

- λ””ν΄νΈ νλΌλ―Έν„° κ°’μ„ μ§€μ›ν•λ” KCallable.callByλ¥Ό μ‚¬μ©ν•΄μ•Ό ν•λ‹¤.

```kotlin
interface KCallable<out R> {
		fun callBy(args: Map<KParameter, Any?>): R
		...
}
```

- κ°’ νƒ€μ…μ— λ”°λΌ μ§λ ¬ν™”κΈ°λ¥Ό κ°€μ Έμ¤κΈ°

```kotlin
fun serializerForType(type: Type): ValueSerializer<out Any?>? =
    when(type) {
        Byte::class.java -> ByteSerializer
        Int::class.java -> IntSerializer
        Boolean::class.java -> BooleanSerializer
        // ...
        else -> null
    }

// Boolean κ°’μ„ μ„ν• μ§λ ¬ν™”κΈ°
object BooleanSerializer : ValueSerialzier<Boolean> {
    override fun fromJsonValue(jsonValue: Any?): Boolean {
        if (jsonValue !is Boolean) throw JkidException("Boolean expected")
        return josnValue
    }
		
    override fun toJsonValue(value: Boolean) = value
}
```

- CallInfoCacheλ” λ¦¬ν”λ ‰μ… μ—°μ‚°μ λΉ„μ©μ„ μ¤„μ΄κΈ° μ„ν• ν΄λμ¤λ‹¤. μ§λ ¬ν™”μ™€ μ—­μ§λ ¬ν™”μ— μ‚¬μ©ν•λ” μ• λ…Έν…μ΄μ…λ“¤μ΄ νλΌλ―Έν„°κ°€ μ•„λ‹λΌ ν”„λ΅νΌν‹°μ— μ μ©λλ‹¤λ” μ‚¬μ‹¤μ„ μ•μ•„μ•Ό ν•λ‹¤.
- ν•μ§€λ§ κ°μ²΄λ¥Ό μ—­μ§λ ¬ν™”ν•  λ•λ” ν”„λ΅νΌν‹°κ°€ μ•„λ‹λΌ μƒμ„±μ νλΌλ―Έν„°λ¥Ό λ‹¤λ¤„μ•Ό ν•λ‹¤. λ”°λΌμ„ μ• λ…Έν…μ΄μ…μ„ κΊΌλ‚΄λ ¤λ©΄ νλΌλ―Έν„°μ— ν•΄λ‹Ήν•λ” ν”„λ΅νΌν‹°λ¥Ό μ°Ύμ•„μ•Ό ν•λ‹¤.

```kotlin
class ClassInfoCache {
    private val cacheData = mutableMapOf<KClass<*>, ClassInfo<*>>()

    @Suppress("UNCHECKED_CAST")
    operator fun <T : Any> get(cls: KClass<T>): ClassInfo<T> =
            cacheData.getOrPut(cls) { ClassInfo(cls) } as ClassInfo<T>
}

// μƒμ„±μ νλΌλ―Έν„°μ™€ μ• λ…Έν…μ΄μ… μ •λ³΄λ¥Ό μ €μ¥ν•λ” μΊμ‹
class ClassInfo<T : Any>(cls: KClass<T>) {
    private val className = cls.qualifiedName
    private val constructor = cls.primaryConstructor
            ?: throw JKidException("Class ${cls.qualifiedName} doesn't have a primary constructor")

    private val jsonNameToParamMap = hashMapOf<String, KParameter>()
    private val paramToSerializerMap = hashMapOf<KParameter, ValueSerializer<out Any?>>()
    private val jsonNameToDeserializeClassMap = hashMapOf<String, Class<out Any>?>()

    init {
        constructor.parameters.forEach { cacheDataForParameter(cls, it) }
    }

    private fun cacheDataForParameter(cls: KClass<*>, param: KParameter) {
        val paramName = param.name
                ?: throw JKidException("Class $className has constructor parameter without name")

        val property = cls.declaredMemberProperties.find { it.name == paramName } ?: return
        val name = property.findAnnotation<JsonName>()?.name ?: paramName
        jsonNameToParamMap[name] = param

        val deserializeClass = property.findAnnotation<DeserializeInterface>()?.targetClass?.java
        jsonNameToDeserializeClassMap[name] = deserializeClass

        val valueSerializer = property.getSerializer()
                ?: serializerForType(param.type.javaType)
                ?: return
        paramToSerializerMap[param] = valueSerializer
    }

    fun getConstructorParameter(propertyName: String): KParameter = jsonNameToParamMap[propertyName]
            ?: throw JKidException("Constructor parameter $propertyName is not found for class $className")

    fun getDeserializeClass(propertyName: String) = jsonNameToDeserializeClassMap[propertyName]

    fun deserializeConstructorArgument(param: KParameter, value: Any?): Any? {
        val serializer = paramToSerializerMap[param]
        if (serializer != null) return serializer.fromJsonValue(value)

        validateArgumentType(param, value)
        return value
    }

    private fun validateArgumentType(param: KParameter, value: Any?) {
        if (value == null && !param.type.isMarkedNullable) {
            throw JKidException("Received null value for non-null parameter ${param.name}")
        }
        if (value != null && value.javaClass != param.type.javaType) {
            throw JKidException("Type mismatch for parameter ${param.name}: " +
                    "expected ${param.type.javaType}, found ${value.javaClass}")
        }
    }

    fun createInstance(arguments: Map<KParameter, Any?>): T {
        ensureAllParametersPresent(arguments)
        return constructor.callBy(arguments)
    }

    private fun ensureAllParametersPresent(arguments: Map<KParameter, Any?>) {
        for (param in constructor.parameters) {
            if (arguments[param] == null && !param.isOptional && !param.type.isMarkedNullable) {
                throw JKidException("Missing value for parameter ${param.name}")
            }
        }
    }
}
```